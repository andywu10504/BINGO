<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BINGO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA 重要 meta -->
  <meta name="theme-color" content="#212529">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Bootstrap 5 + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    body { background: #f8f9fa; padding-top: 20px; }

    .game-container { max-width: 540px; }

    .board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 15px;
      margin-bottom: 15px;
    }

    .cell {
      aspect-ratio: 1;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      text-align: center;
      padding: 4px;
      transition: background 0.15s ease;
      overflow: hidden;
    }

    .cell.active {
      background: #ffc107;
      box-shadow: inset 0 0 0 2px #fd7e14;
    }

    .big-btn {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
<div class="container d-flex flex-column align-items-center">
  <div class="game-container w-100">
    <!-- ===== 遊戲卡片 ===== -->
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-table-cells-large me-1"></i>BINGO</span>
        <span class="badge bg-warning text-dark">
          <i class="fa-solid fa-lines-leaning me-1"></i>
          目前連線：<span id="lineCount">0</span> 條
        </span>
      </div>

      <div class="card-body">

        <!-- 玩法模式 -->
        <div class="d-flex justify-content-between mb-2">
          <div class="d-flex align-items-center">
            <label class="me-2 small text-muted">
              <i class="fa-solid fa-gear me-1"></i>玩法模式
            </label>
            <select id="gameMode" class="form-select form-select-sm">
              <option value="number">數字 BINGO</option>
              <option value="quiz-xin">新興救護 BINGO</option>
              <option value="quiz-emt">EMT BINGO</option>
            </select>
          </div>

          <button id="btnClear" class="btn btn-sm btn-outline-secondary">
            <i class="fa-solid fa-eraser me-1"></i>清除
          </button>
        </div>

        <!-- 遊戲盤 -->
        <div id="board" class="board"></div>

        <button id="btnShuffle" class="btn btn-primary big-btn">
          <i class="fa-solid fa-shuffle me-2"></i>抽卡
        </button>

      </div>
    </div>

    <!-- ===== 設定 ===== -->
    <div class="card shadow-sm mt-3 w-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-sliders me-1"></i>遊戲設定</span>
        <button class="btn btn-sm btn-outline-secondary"
                data-bs-toggle="collapse" data-bs-target="#settingsCollapse">
          <i class="fa-solid fa-angle-down"></i>
        </button>
      </div>

      <div class="collapse show" id="settingsCollapse">
        <div class="card-body bg-light">

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="fa-solid fa-th me-1"></i>列 x 欄</span>
            <input id="rowsInput" type="number" class="form-control" min="1" max="10">
            <span class="input-group-text">x</span>
            <input id="colsInput" type="number" class="form-control" min="1" max="10">
          </div>

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="fa-solid fa-hashtag me-1"></i>範圍</span>
            <input id="numMin" type="number" class="form-control">
            <span class="input-group-text">~</span>
            <input id="numMax" type="number" class="form-control">
          </div>

          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fa-solid fa-text-height me-1"></i>字體</span>
            <input id="fontSizeInput" type="number" class="form-control" step="0.1" min="0.5" max="3">
            <span class="input-group-text">rem</span>
          </div>

          <small class="text-muted">
            <i class="fa-regular fa-circle-info me-1 mt-2"></i>按「抽卡」套用設定
          </small>

        </div>
      </div>
    </div>

  </div>
</div>
<script>
/* ============================
   集中所有參數（唯一要改的地方）
============================ */
const PARAMS = {
  DEFAULT_NUMBER_FONT: 2.5,
  DEFAULT_QUIZ_FONT: 0.9,
  DEFAULT_ROWS: 5,
  DEFAULT_COLS: 5,
  DEFAULT_MIN: 1,
  DEFAULT_MAX: 25
};

const LS_KEY = "BINGO_SAVE_v1";

let ROWS = PARAMS.DEFAULT_ROWS;
let COLS = PARAMS.DEFAULT_COLS;
let NUM_MIN = PARAMS.DEFAULT_MIN;
let NUM_MAX = PARAMS.DEFAULT_MAX;
let CELL_FONT_REM = 1.1;

/* ============================
   題庫
============================ */
const BANK_XIN = [
  "高醫","阮綜合醫院","大同醫院","下雨天協勤","內科OHCA","Trauma OHCA","聖功醫院",
  "長庚醫院","榮民總醫院","車上CPR","凱旋醫院","民生醫院","遇到精神病患",
  "強制送醫使用約束帶","解鎖燒燙傷","火警救護","小飛俠","晴天娃娃","打撈",
  "明顯死亡(屍僵屍腐)","明顯死亡(頭首分離)","急產接生","脫襪式傷口","低血糖",
  "低血壓","瀕死式呼吸","耳漏鼻漏","執行辛辛那提異常","EKG","血糖","備IV",
  "上頸圈","翻身上長背板","破門","正確使用器材給氧","BVM給氧","進階呼吸道給氧",
  "架設LUCAS","使用電動擔架","使用搬運椅","使用傳統擔架","抽吸式護木","斷肢",
  "發燒","急性心肌梗塞(MI)","慢性阻塞性肺病（COPD）","非OHCA GCS 3分","一氧化碳中毒",
  "線上派遣","醫師線上指導","酒醉路到","吸毒過量","自殘","同時有3個以上傷患",
  "獨自評估患者","獨自處置患者","頭部外傷 GCS小於15","骨盆不穩定"
];

const BANK_EMT = [
  "下雨天協勤","內科OHCA","Trauma OHCA","車上CPR","遇到精神病患",
  "強制送醫使用約束帶","解鎖燒燙傷","火警救護","小飛俠","晴天娃娃",
  "打撈","明顯死亡(屍僵屍腐)","明顯死亡(頭首分離)","急產接生","脫襪式傷口",
  "低血糖","低血壓","瀕死式呼吸","耳漏鼻漏","執行辛辛那提異常","EKG","血糖",
  "備IV","上頸圈","翻身上長背板","破門","正確使用器材給氧","BVM給氧",
  "進階呼吸道給氧","架設LUCAS","使用電動擔架","使用搬運椅","使用傳統擔架",
  "抽吸式護木","斷肢","發燒","急性心肌梗塞(MI)","慢性阻塞性肺病（COPD）",
  "非OHCA GCS 3分","一氧化碳中毒","線上派遣","醫師線上指導","酒醉路到",
  "吸毒過量","自殘","同時有3個以上傷患","獨自評估患者","獨自處置患者",
  "頭部外傷 GCS小於15","骨盆不穩定"
];

/* ============================
   初始化
============================ */
$(function () {
  if (!loadFromLocal()) {
    applyModeDefaults();
    initBoard(getMode());
  }
  bindEvents();
});

/* 取得當前模式 */
function getMode() { return $("#gameMode").val(); }

/* 不同玩法 → 使用不同預設字體 */
function applyModeDefaults() {
  const mode = getMode();
  CELL_FONT_REM = (mode === "number")
      ? PARAMS.DEFAULT_NUMBER_FONT
      : PARAMS.DEFAULT_QUIZ_FONT;

  $("#fontSizeInput").val(CELL_FONT_REM);
}

/* ============================
   設定讀取
============================ */
function readSettings() {
  ROWS = Number($("#rowsInput").val());
  COLS = Number($("#colsInput").val());
  NUM_MIN = Number($("#numMin").val());
  NUM_MAX = Number($("#numMax").val());
  CELL_FONT_REM = Number($("#fontSizeInput").val());
}

/* ============================
   盤面生成
============================ */
function initBoard(mode, presetCells=null, presetActive=null) {
  const board = $("#board").empty();
  board.css("grid-template-columns", `repeat(${COLS}, 1fr)`);

  const size = ROWS * COLS;
  let data = [];

  if (presetCells) data = presetCells;
  else if (mode === "number") data = shuffle(range(NUM_MIN, NUM_MAX)).slice(0, size);
  else if (mode === "quiz-xin") data = shuffle(BANK_XIN).slice(0, size);
  else if (mode === "quiz-emt") data = shuffle(BANK_EMT).slice(0, size);

  for (let i=0;i<size;i++) {
    const active = presetActive ? presetActive[i] : false;

    $("<div>")
      .addClass("cell")
      .toggleClass("active", active)
      .text(data[i])
      .css("font-size", CELL_FONT_REM+"rem")
      .appendTo(board);
  }

  updateLineCount();
  saveToLocal();
}

/* ============================
   事件
============================ */
function bindEvents() {

  $("#board").on("click", ".cell", function () {
    $(this).toggleClass("active");
    updateLineCount();
    saveToLocal();
  });

  $("#btnShuffle").on("click", function () {
    readSettings();
    applyModeDefaults();
    initBoard(getMode());
  });

  $("#btnClear").on("click", function () {
    $(".cell").removeClass("active");
    updateLineCount();
    saveToLocal();
  });

  $("#gameMode").on("change", function () {
    applyModeDefaults();
    readSettings();
    initBoard(getMode());
  });

  $("#rowsInput,#colsInput,#numMin,#numMax,#fontSizeInput")
    .on("change", function () {
      readSettings();
      initBoard(getMode());
    });
}

/* ============================
   計算 BINGO 連線
============================ */
function updateLineCount() {
  let count = 0;
  const sel = [];

  for (let r=0;r<ROWS;r++) {
    sel[r] = [];
    for (let c=0;c<COLS;c++) {
      sel[r][c] = $("#board .cell").eq(r*COLS+c).hasClass("active");
    }
  }

  for (let r=0;r<ROWS;r++) if (sel[r].every(v=>v)) count++;
  for (let c=0;c<COLS;c++) {
    let ok = true;
    for (let r=0;r<ROWS;r++) if (!sel[r][c]) ok=false;
    if (ok) count++;
  }

  let d1=true, d2=true;
  for (let i=0;i<ROWS;i++){
    if (!sel[i][i]) d1=false;
    if (!sel[i][COLS-1-i]) d2=false;
  }
  if (d1) count++;
  if (d2) count++;

  $("#lineCount").text(count);
}

/* ============================
   LocalStorage
============================ */
function saveToLocal() {
  const cells = [];
  const active = [];

  $(".cell").each(function () {
    cells.push($(this).text());
    active.push($(this).hasClass("active"));
  });

  const obj = {
    rows: ROWS, cols: COLS,
    min: NUM_MIN, max: NUM_MAX,
    font: CELL_FONT_REM,
    mode: getMode(),
    cells, active
  };

  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}

function loadFromLocal() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;

  try {
    const d = JSON.parse(raw);

    ROWS = d.rows;
    COLS = d.cols;
    NUM_MIN = d.min;
    NUM_MAX = d.max;
    CELL_FONT_REM = d.font;

    $("#rowsInput").val(ROWS);
    $("#colsInput").val(COLS);
    $("#numMin").val(NUM_MIN);
    $("#numMax").val(NUM_MAX);
    $("#fontSizeInput").val(CELL_FONT_REM);
    $("#gameMode").val(d.mode);

    initBoard(d.mode, d.cells, d.active);
    return true;
  } catch {
    return false;
  }
}

/* ============================
   工具
============================ */
function range(a,b){const r=[];for(let i=a;i<=b;i++)r.push(i);return r;}
function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* ============================
   PWA Service Worker 註冊
============================ */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .then(reg => console.log("ServiceWorker 已註冊:", reg.scope))
      .catch(err => console.log("SW 註冊失敗:", err));
  });
}
</script>
